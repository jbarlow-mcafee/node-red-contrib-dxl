<script type="text/javascript">
  (function () {
    var payloadTypes = [
      {v: 'txt', t: 'a UTF-8 string'},
      {v: 'bin', t: 'a binary buffer'},
      {v: 'obj', t: 'a parsed JSON object'}
    ]

    RED.nodes.registerType('dxl-service in', {
      category: 'input',
      defaults: {
        name: {value: ''},
        serviceType: {value: '', required: true},
        client: {type: 'dxl-client',
          required: false,
          validate: function () { return DXL.validators.client(this) }
        },
        rules: {value: [{payloadType: 'txt', topic: ''}]},
        outputs: {value: 1}
      },
      color: '#5ccfe2',
      inputs: 0,
      outputs: 1,
      outputLabels: function (index) {
        var label = ''
        var rule = this.rules[index]
        if (rule) {
          label = rule.topic
        }
        return label
      },
      icon: 'opendxl.png',
      label: function () {
        return this.name || this.topic || 'dxl service'
      },
      labelStyle: function () {
        return this.name ? 'node_label_italic' : ''
      },
      oneditprepare: function () {
        var node = this
        var outputCount = $('#node-input-outputs').val('{}')

        $('#node-input-rule-container').css('min-height', '250px').css('min-width', '450px').editableList({
          addItem: function (container, i, opt) {
            if (!opt.hasOwnProperty('r')) {
              opt.r = {}
            }
            var rule = opt.r
            if (!rule.hasOwnProperty('payloadType')) {
              rule.payloadType = 'txt'
            }
            if (!opt.hasOwnProperty('i')) {
              opt._i = Math.floor((0x99999 - 0x10000) * Math.random()).toString(16)
            }

            var row1 = $('<div/>').appendTo(container)
            var row2 = $('<div/>', {style: 'margin-top:8px;'}).appendTo(container)

            $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
              .text('Topic')
              .appendTo(row1)
            var topicValue = $('<input/>', {class: 'node-input-rule-topic-value', type: 'text'}).appendTo(row1)

            $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
              .text('Payload type')
              .appendTo(row2)
            var payloadTypeField = $('<select/>', {style: 'width:200px; text-align: center;'}).appendTo(row2)
            for (var d in payloadTypes) {
              payloadTypeField.append($('<option></option>').val(payloadTypes[d].v).text(payloadTypes[d].t))
            }

            var finalspan = $('<span/>', {style: 'float: right;margin-top: 6px;'}).appendTo(row1)
            finalspan.append(' &#8594; <span class="node-input-rule-index">' + (i + 1) + '</span> ')
            payloadTypeField.val(rule.payloadType)
            if (typeof rule.topic !== 'undefined') {
              topicValue.val(rule.topic)
            }
            payloadTypeField.change()

            var currentOutputs = JSON.parse(outputCount.val() || '{}')
            currentOutputs[opt.hasOwnProperty('i') ? opt.i : opt._i] = i
            outputCount.val(JSON.stringify(currentOutputs))
          },
          removeItem: function (opt) {
            var currentOutputs = JSON.parse(outputCount.val() || '{}')
            if (opt.hasOwnProperty('i')) {
              currentOutputs[opt.i] = -1
            } else {
              delete currentOutputs[opt._i]
            }
            var rules = $('#node-input-rule-container').editableList('items')
            rules.each(function (i) {
              $(this).find('.node-input-rule-index').html(i + 1)
              var data = $(this).data('data')
              currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i
            })
            outputCount.val(JSON.stringify(currentOutputs))
          },
          sortItems: function () {
            var currentOutputs = JSON.parse(outputCount.val() || '{}')
            var rules = $('#node-input-rule-container').editableList('items')
            rules.each(function (i) {
              $(this).find('.node-input-rule-index').html(i + 1)
              var data = $(this).data('data')
              currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i
            })
            outputCount.val(JSON.stringify(currentOutputs))
          },
          sortable: true,
          removable: true
        })

        for (var i = 0; i < node.rules.length; i++) {
          var rule = node.rules[i]
          $('#node-input-rule-container').editableList('addItem', {r: rule, i: i})
        }
      },
      oneditsave: function () {
        var rules = $('#node-input-rule-container').editableList('items')
        var node = this
        node.rules = []
        rules.each(function () {
          var rule = $(this)
          var type = rule.find('select').val()
          var r = {payloadType: type}
          r.topic = rule.find('.node-input-rule-topic-value').val()
          node.rules.push(r)
        })
      },
      oneditresize: function (size) {
        var rows = $('#dialog-form>div:not(.node-input-rule-container-row)')
        var height = size.height
        for (var i = 0; i < rows.size(); i++) {
          height -= $(rows[i]).outerHeight(true)
        }
        var editorRow = $('#dialog-form>div.node-input-rule-container-row')
        height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')))
        $('#node-input-rule-container').editableList('height', height)
      }
    })
  })()
</script>

<script type="text/x-red" data-template-name="dxl-service in">
    <div class="form-row">
        <label for="node-input-client"><i class="icon-tag"></i> Client</label>
        <input type="text" id="node-input-client" placeholder="Client">
    </div>
    <div class="form-row">
        <label for="node-input-serviceType"><i class="fa fa-tag"></i> Service Type</label>
        <input type="text" id="node-input-serviceType" placeholder="Service Type">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
        <input type="hidden" id="node-input-outputs"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="dxl-service in">
    <p>Registers a service with the DXL fabric. When a request message is received by the service, a corresponding new message is injected into a flow.</p>
    <p>For more information on services, see the <a href="https://opendxl.github.io/opendxl-client-python/pydoc/dxlclient.service.html">service documentation</a> in the OpenDXL Python client SDK.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
       <dt>payload <span class="property-type">string | buffer</span></dt>
       <dd> The application-specific payload of the message. Through the <i>Payload type</i> property value for <i>Topic</i> entry which matches the request, the node can be configured to set the request payload as a UTF-8 String, an Object parsed from a JSON formatted string, or as a binary Buffer.</dd>

       <dt>topic <span class="property-type">string</span></dt>
       <dd> The topic to which the request was published.</dd>

       <dt>dxlRequest <span class="property-type">dxl-client.Request</d></span></dt>
       <dd> The <a href="https://opendxl.github.io/opendxl-client-javascript/Request.html" target="_blank">Request</a> object received from the DXL client for the published request.</dd>

       <dt>dxlMessage <span class="property-type">dxl-client.Message</d></span></dt>
       <dd> The <a href="https://opendxl.github.io/opendxl-client-javascript/Request.html" target="_blank">Request</a> object received from the DXL client for the published request.</dd>
    </dl>
    <h3>Details</h3>
    <p>DXL Services are exposed to the DXL fabric and are invoked in a fashion similar to RESTful web services.
    Communication between an invoking client and the DXL service is one-to-one (request/response).</p>
    <p>Each service is identified by the <i>topics</i> it responds to.
    Each of these <i>topics</i> can be thought of as a method that is being "invoked" on the service by the remote client.</p>
    <p>Multiple service “instances” can be registered with the DXL fabric that respond to the same <i>topics</i>.
    When this occurs (unless explicitly overridden by the client) the fabric will select the particular instance to route the request to (by default round-robin).
    Multiple service instances can be used to increase scalability and fault-tolerance.</p>
    <p>When a request is received by the Node-RED DXL service node, the node will evaluate the request topic against each of the node's <i>Topic</i> entries and inject a new message into the corresponding output node(s).
    <p><b>Note:</b> this node does not send a response to the request. The flow must include an DXL response node to complete the request.</p>
    <p><i>Client</i> is the configuration node for the DXL client through which the service registration should be sent and service requests should be received.
    Click on the pencil icon to add or modify a client configuration.</p>
    <p><i>Service Type</i> is a textual name for the service. This name is supplied to the DXL fabric during service registration.</p>
    <p><i>Name</i> is only used for display purposes in the Node-RED user interface.<p>
    <p>For each output entry:<p>
    <p><i>Topic</i> is the topic to subscribe to for request notifications.</p>
    <p><i>Payload type</i> controls the data type for the <code>msg.payload</code> property in the new message injected into a flow.
    If the value is set to <i>a binary buffer</i>, the raw binary Buffer received in the DXL request payload is forwarded along.
    If the value is set to <i>a UTF-8 string</i>, the binary Buffer is decoded from UTF-8 octets into a String.
    If the value is set to <i>a parsed JSON object</i>, the binary Buffer is decoded into a UTF-8 string and parsed as JSON text into an Object.
    If an error occurs when attempting to convert the binary Buffer of the payload into the desired data type, the current flow is halted with an error.
    In the error case, the request message can be retrieved from a catch node via the <code>msg.dxlRequest</code> property.</p>
</script>
